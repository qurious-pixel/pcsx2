name: AppImage Build

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches:
      - z-app-test
    paths-ignore:
      - .gitignore
      - "**/*.md"
      - .clang-format
      - debian-packager/
      - bin/PCSX2_keys.ini.default
      - "pcsx2/PAD/Windows/**"
  pull_request:
    branches:
      - master
    paths-ignore:
      - .gitignore
      - "**/*.md"
      - .clang-format
      - debian-packager/
      - bin/PCSX2_keys.ini.default
      - "pcsx2/PAD/Windows/**"

jobs:
  build:
    strategy:
      # Prevent one build from failing everything (although maybe those should be included as experimental builds instead)
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-18.04
            platform: x86
            compiler: gcc
            detail: -appimage
            experimental: true
          - os: ubuntu-18.04
            platform: x64
            compiler: gcc
            experimental: true
            detail: -appimage

    name: ${{ matrix.os }}-${{ matrix.platform }}-${{ matrix.compiler }}${{ matrix.detail }}
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental }}
    # Set some sort of timeout in the event of run-away builds.  We are limited on concurrent jobs so, get rid of them.
    timeout-minutes: 30

    steps:
      # NOTE - useful for debugging
      # - name: Dump GitHub context
      #   env:
      #     GITHUB_CONTEXT: ${{ toJson(github) }}
      #   run: |
      #     echo "$GITHUB_CONTEXT"
      #     echo ${{ github.event.pull_request.title }}

      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: ccache cache files
        uses: actions/cache@v2.1.6
        with:
          path: .ccache
          key: ${{ matrix.os }}-${{ matrix.platform }}-${{ matrix.compiler }}${{ matrix.detail }}-ccache-${{ steps.ccache_cache_timestamp.outputs.timestamp }}
          restore-keys: |
            ${{ matrix.os }}-${{ matrix.platform }}-${{ matrix.compiler }}${{ matrix.detail }}-ccache-

      - name: Checkout Submodules
        if: steps.cache-submodules.outputs.cache-hit != 'true'
        run: git submodule update --init --recursive --jobs 2

      # -- SETUP CCACHE - https://cristianadam.eu/20200113/speeding-up-c-plus-plus-github-actions-using-ccache/
      - name: Prepare ccache timestamp
        id: ccache_cache_timestamp
        shell: cmake -P {0}
        run: |
          string(TIMESTAMP current_date "%Y-%m-%d-%H;%M;%S" UTC)
          message("::set-output name=timestamp::${current_date}")

      - name: ccache cache files
        uses: actions/cache@v2.1.6
        with:
          path: .ccache
          key: ${{ matrix.os }}-${{ matrix.platform }}-${{ matrix.compiler }}${{ matrix.detail }}-ccache-${{ steps.ccache_cache_timestamp.outputs.timestamp }}
          restore-keys: ${{ matrix.os }}-${{ matrix.platform }}-${{ matrix.compiler }}${{ matrix.detail }}-ccache-

      - name: Prepare Artifact Metadata
        id: artifact-metadata
        shell: bash
        run: |
          ARCH=$([ "${{ matrix.platform }}" == x86 ] && echo "32bit" || echo "64bit")
          ARTIFACT_NAME=""
          if [ ${{ github.event_name }} == "pull_request" ]; then
            PR_SHA=$(git rev-parse --short "${{ github.event.pull_request.head.sha }}")
            ARTIFACT_NAME="PCSX2-${ARCH}"
            if [ ! -z "${{ github.event.pull_request.number }}" ]; then
              PR_NUM=${{ github.event.pull_request.number }}
              ARTIFACT_NAME="${ARTIFACT_NAME}-pr[${PR_NUM}]"
            fi
            ARTIFACT_NAME="${ARTIFACT_NAME}-sha[${PR_SHA}]"
            if [ ! -z "${{ github.event.pull_request.title }}" ]; then
              PR_TITLE=$(echo "${{ github.event.pull_request.title }}" | tr -cd '[a-zA-Z0-9[:space:]]_-')
              ARTIFACT_NAME="${ARTIFACT_NAME}-title["${PR_TITLE}""
            fi
          else
            SHA=$(git rev-parse --short "$GITHUB_SHA")
            ARTIFACT_NAME="PCSX2-${ARCH}-sha[${SHA}"
          fi
          TRIMMED_ARTIFACT_NAME=$(printf "%.199s]" "$ARTIFACT_NAME")
          echo "name=$TRIMMED_ARTIFACT_NAME"
          echo "##[set-output name=name;]${TRIMMED_ARTIFACT_NAME}"

      - name: Install Packages
        continue-on-error: true
        id: packages
        run: |
          if [ ${{ matrix.platform }} = x86 ]; then
            PKGARCH=i386
            sudo dpkg --add-architecture i386
          else
            PKGARCH=amd64
          fi
          echo "PKGARCH $PKGARCH"
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update && sudo apt-get -y full-upgrade
          sudo apt-get install -y build-essential:${PKGARCH} ccache:${PKGARCH} cmake:${PKGARCH} curl:${PKGARCH} \
          dialog:${PKGARCH} dpkg:${PKGARCH} fuse:${PKGARCH} gcc:${PKGARCH} gcc-8-multilib g++:${PKGARCH} g++-8-multilib gettext:${PKGARCH} \
          git:${PKGARCH} libaio-dev:${PKGARCH} libasound2-dev:${PKGARCH} libbz2-dev:${PKGARCH} libcggl:${PKGARCH} libegl1-mesa-dev:${PKGARCH} \
          libgl1-mesa-dev:${PKGARCH} libgles2-mesa-dev:${PKGARCH} libglew-dev:${PKGARCH} libglvnd-dev:${PKGARCH} libgtk-3-dev:${PKGARCH} libgtk2.0-dev:${PKGARCH} \
          libjack-jackd2-dev:${PKGARCH} libjpeg-dev:${PKGARCH} liblzma-dev:${PKGARCH} liblzma5:${PKGARCH} libpcap0.8-dev:${PKGARCH} libpng++-dev:${PKGARCH} \
          libpng-dev:${PKGARCH} libportaudiocpp0:${PKGARCH} libsamplerate0-dev:${PKGARCH} libsdl1.2-dev:${PKGARCH} libsdl2-dev:${PKGARCH} \
          libsoundtouch-dev:${PKGARCH} libwxgtk3.0-dev:${PKGARCH} libwxgtk3.0-gtk3-dev:${PKGARCH} libxext-dev:${PKGARCH} libxml2-dev:${PKGARCH} \
          libxml2-dev:${PKGARCH} make:${PKGARCH} ninja-build nvidia-cg-toolkit:${PKGARCH} portaudio19-dev:${PKGARCH} \
          wget:${PKGARCH} zenity:${PKGARCH} zlib1g-dev:${PKGARCH}
          update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 10
          update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-8 10
          cd /tmp
          curl -sSfLO https://github.com/NixOS/patchelf/releases/download/0.12/patchelf-0.12.tar.bz2        tar xvf patchelf-0.12.tar.bz2
          cd patchelf-0.12*/ 
          ./configure
          make && make install

      - name: Build AppImage
        env:
          PLATFORM: ${{ matrix.platform }}
          COMPILER: ${{ matrix.compiler }}
          name: ${{ steps.artifact-metadata.outputs.name }}
        run: |
          #cd pcsx2
          mkdir build && cd build
          cmake ..                                    \
          -DCMAKE_C_COMPILER=/usr/lib/ccache/gcc      \
          -DCMAKE_CXX_COMPILER=/usr/lib/ccache/g++    \
          -DCMAKE_BUILD_TYPE=Release                  \
          -DPACKAGE_MODE=TRUE                         \
          -DXDG_STD=TRUE                              \
          -DDISABLE_ADVANCE_SIMD=TRUE                 \
          -DCMAKE_INSTALL_LIBDIR="/tmp/"              \
          -DCMAKE_INSTALL_DATADIR="/tmp/"             \
          -DCMAKE_INSTALL_DOCDIR="/tmp/PCSX2"         \
          -DOpenGL_GL_PREFERENCE="LEGACY"             \
          -DOPENGL_opengl_LIBRARY=""                  \
          -GNinja
          ninja
          ls -al .

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ steps.artifact-metadata.outputs.name }}
          path: artifacts
